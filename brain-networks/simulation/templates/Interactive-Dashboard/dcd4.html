<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCD 4.0 Dashboard</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.1.1/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.1.1/plotly-locale-ru.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }
        
        .dashboard {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 0.95em;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .control-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #555;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .control-group input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .control-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
        }
        
        .value-display {
            display: inline-block;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            color: #667eea;
            margin-left: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .viz-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .viz-panel h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .plot-container {
            width: 100%;
            height: 400px;
        }
        
        .status-bar {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .status-item {
            display: inline-block;
            margin-right: 30px;
            font-size: 0.9em;
        }
        
        .status-label {
            font-weight: 600;
            color: #667eea;
        }
        
        .region-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .region-btn {
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        
        .region-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .region-btn:hover {
            border-color: #667eea;
        }
        
        @media (max-width: 768px) {
            .controls-grid, .viz-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üß† DCD 4.0 Interactive Dashboard</h1>
            <p>Differentiable Consciousness Dynamics - –ú–µ—Ö–∞–Ω–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å —Å–æ–∑–Ω–∞–Ω–∏—è —Å –∫–∞—É–∑–∞–ª—å–Ω—ã–º–∏ —Å–≤—è–∑—è–º–∏</p>
        </div>
        
        <div class="controls-grid">
            <!-- Causal Weights -->
            <div class="control-panel">
                <h3>‚ö° –ö–∞—É–∑–∞–ª—å–Ω—ã–µ –≤–µ—Å–∞ (Granger calibrated)</h3>
                <div class="control-group">
                    <label>w_LC (L‚ÜíC arousal gain): <span class="value-display" id="val-wLC">0.58</span></label>
                    <input type="range" id="wLC" min="0.3" max="0.9" step="0.01" value="0.58">
                </div>
                <div class="control-group">
                    <label>w_CL (C‚ÜíL novelty): <span class="value-display" id="val-wCL">0.28</span></label>
                    <input type="range" id="wCL" min="0.1" max="0.5" step="0.01" value="0.28">
                </div>
                <div class="control-group">
                    <label>w_LS (L‚ÜíS PFC thresh): <span class="value-display" id="val-wLS">0.72</span></label>
                    <input type="range" id="wLS" min="0.4" max="1.0" step="0.01" value="0.72">
                </div>
                <div class="control-group">
                    <label>w_SL (S‚ÜíL metacog): <span class="value-display" id="val-wSL">0.18</span></label>
                    <input type="range" id="wSL" min="0.1" max="0.4" step="0.01" value="0.18">
                </div>
                <div class="control-group">
                    <label>w_CS (C‚ÜíS content): <span class="value-display" id="val-wCS">0.53</span></label>
                    <input type="range" id="wCS" min="0.3" max="0.7" step="0.01" value="0.53">
                </div>
                <div class="control-group">
                    <label>w_SC (S‚ÜíC attention): <span class="value-display" id="val-wSC">0.42</span></label>
                    <input type="range" id="wSC" min="0.2" max="0.6" step="0.01" value="0.42">
                </div>
            </div>
            
            <!-- Ignition Parameters -->
            <div class="control-panel">
                <h3>üî• Ignition & Binding</h3>
                <div class="control-group">
                    <label>k_ign (steepness): <span class="value-display" id="val-kign">2.3</span></label>
                    <input type="range" id="kign" min="1.0" max="3.0" step="0.1" value="2.3">
                </div>
                <div class="control-group">
                    <label>L_thresh (PCI‚âà0.34): <span class="value-display" id="val-Lthresh">3.4</span></label>
                    <input type="range" id="Lthresh" min="2.5" max="4.5" step="0.1" value="3.4">
                </div>
                <div class="control-group">
                    <label>Œ±_att (attention mod): <span class="value-display" id="val-alphaAtt">0.5</span></label>
                    <input type="range" id="alphaAtt" min="0" max="1" step="0.05" value="0.5">
                </div>
                <div class="control-group">
                    <label>k_bind (binding coef): <span class="value-display" id="val-kbind">0.05</span></label>
                    <input type="range" id="kbind" min="0" max="0.2" step="0.01" value="0.05">
                </div>
                <div class="control-group">
                    <label>C_optimal: <span class="value-display" id="val-Copt">7.5</span></label>
                    <input type="range" id="Copt" min="5" max="10" step="0.5" value="7.5">
                </div>
            </div>
            
            <!-- Self/Metacognition -->
            <div class="control-panel">
                <h3>üé≠ Self & Metacognition</h3>
                <div class="control-group">
                    <label>L_crit (PFC threshold): <span class="value-display" id="val-Lcrit">4.0</span></label>
                    <input type="range" id="Lcrit" min="3.0" max="5.0" step="0.1" value="4.0">
                </div>
                <div class="control-group">
                    <label>Œ≤_intero (aINS): <span class="value-display" id="val-betaIntero">0.5</span></label>
                    <input type="range" id="betaIntero" min="0" max="1" step="0.05" value="0.5">
                </div>
                <div class="control-group">
                    <label>Œ±_agency (disruption): <span class="value-display" id="val-alphaAgency">0.10</span></label>
                    <input type="range" id="alphaAgency" min="0" max="0.3" step="0.01" value="0.10">
                </div>
                <div class="control-group">
                    <label>Œ±_psych (DMN suppress): <span class="value-display" id="val-alphaPsych">4.8</span></label>
                    <input type="range" id="alphaPsych" min="0" max="10" step="0.1" value="4.8">
                </div>
            </div>
            
            <!-- Diffusion & Decay -->
            <div class="control-panel">
                <h3>üåä Spatial Coupling & Decay</h3>
                <div class="control-group">
                    <label>D_L (level diffusion): <span class="value-display" id="val-DL">0.05</span></label>
                    <input type="range" id="DL" min="0" max="0.2" step="0.01" value="0.05">
                </div>
                <div class="control-group">
                    <label>D_C (content spread): <span class="value-display" id="val-DC">0.15</span></label>
                    <input type="range" id="DC" min="0" max="0.3" step="0.01" value="0.15">
                </div>
                <div class="control-group">
                    <label>D_S (self coupling): <span class="value-display" id="val-DS">0.02</span></label>
                    <input type="range" id="DS" min="0" max="0.1" step="0.01" value="0.02">
                </div>
                <div class="control-group">
                    <label>Œ¥_C (content decay): <span class="value-display" id="val-deltaC">0.5</span></label>
                    <input type="range" id="deltaC" min="0.1" max="1.0" step="0.05" value="0.5">
                </div>
            </div>
            
            <!-- Neuromodulators -->
            <div class="control-panel">
                <h3>üíä Neuromodulators</h3>
                <div class="control-group">
                    <label>ACh concentration: <span class="value-display" id="val-ACh">1.0</span></label>
                    <input type="range" id="ACh" min="0" max="2" step="0.1" value="1.0">
                </div>
                <div class="control-group">
                    <label>NE (norepinephrine): <span class="value-display" id="val-NE">1.0</span></label>
                    <input type="range" id="NE" min="0" max="2" step="0.1" value="1.0">
                </div>
                <div class="control-group">
                    <label>Orexin: <span class="value-display" id="val-Orx">1.0</span></label>
                    <input type="range" id="Orx" min="0" max="2" step="0.1" value="1.0">
                </div>
                <div class="control-group">
                    <label>Psilocybin (DMN): <span class="value-display" id="val-Psilo">0.0</span></label>
                    <input type="range" id="Psilo" min="0" max="1" step="0.05" value="0.0">
                </div>
            </div>
            
            <!-- Simulation Control -->
            <div class="control-panel">
                <h3>‚öôÔ∏è Simulation Settings</h3>
                <div class="control-group">
                    <label>Scenario:</label>
                    <select id="scenario">
                        <option value="wake">Wake (baseline)</option>
                        <option value="N2">N2 Sleep</option>
                        <option value="N3">N3 Deep Sleep</option>
                        <option value="propofol">Propofol Anesthesia</option>
                        <option value="psychedelic">Psychedelic (Psilocybin)</option>
                        <option value="meditation">Meditation</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Duration (min): <span class="value-display" id="val-duration">60</span></label>
                    <input type="range" id="duration" min="10" max="360" step="10" value="60">
                </div>
                <div class="control-group">
                    <label>Time step (ms): <span class="value-display" id="val-dt">10</span></label>
                    <input type="number" id="dt" min="1" max="100" value="10">
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="runSimulation()">‚ñ∂ Run Simulation</button>
                    <button class="btn-secondary" onclick="resetParams()">‚Üª Reset</button>
                </div>
            </div>
        </div>
        
        <!-- Region Selection -->
        <div class="control-panel">
            <h3>üó∫Ô∏è Region Selection (13 regions)</h3>
            <div class="region-selector" id="regionSelector"></div>
        </div>
        
        <!-- Visualizations -->
        <div class="viz-grid">
            <div class="viz-panel">
                <h3>üìà Trajectory 3D (L, C, S)</h3>
                <div id="plot3D" class="plot-container"></div>
            </div>
            
            <div class="viz-panel">
                <h3>üìä Time Series (Mean L, C, S)</h3>
                <div id="plotTimeSeries" class="plot-container"></div>
            </div>
            
            <div class="viz-panel">
                <h3>üî• Regional Heatmap (Level L)</h3>
                <div id="plotHeatmap" class="plot-container"></div>
            </div>
            
            <div class="viz-panel">
                <h3>üß© DMN vs Non-DMN Self</h3>
                <div id="plotDMN" class="plot-container"></div>
            </div>
            
            <div class="viz-panel">
                <h3>üéØ Phase Portrait (L-C)</h3>
                <div id="plotPhase" class="plot-container"></div>
            </div>
            
            <div class="viz-panel">
                <h3>‚ö° Causal Network Graph</h3>
                <div id="plotNetwork" class="plot-container"></div>
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <span class="status-item"><span class="status-label">Status:</span> <span id="statusText">Ready</span></span>
            <span class="status-item"><span class="status-label">R¬≤ (validation):</span> <span id="r2Value">--</span></span>
            <span class="status-item"><span class="status-label">Clinical State:</span> <span id="clinicalState">--</span></span>
            <span class="status-item"><span class="status-label">PCI estimate:</span> <span id="pciValue">--</span></span>
        </div>
    </div>

    <script>
        // Region names (13 regions from HCP-simplified)
        const REGIONS = ['V1', 'V4', 'MT', 'IT', 'dlPFC', 'rlPFC', 'ACC', 'IPS', 'aINS', 'PCC', 'Claustrum', 'Pulvinar', 'SC'];
        const DMN_INDICES = [4, 5, 9]; // dlPFC, rlPFC, PCC
        
        let selectedRegions = [0, 4, 5, 8, 9]; // Default: V1, dlPFC, rlPFC, aINS, PCC
        let currentSolution = null;
        
        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ plotly –∏ —Ñ–∞–π–ª–∞ –ª–æ–∫–∞–ª–∏
        if (window.Plotly && typeof Plotly.setPlotConfig === 'function') {
            Plotly.setPlotConfig({ locale: 'ru' });
        }
        
        // Initialize region selector
        function initRegionSelector() {
            const container = document.getElementById('regionSelector');
            REGIONS.forEach((region, idx) => {
                const btn = document.createElement('button');
                btn.className = 'region-btn' + (selectedRegions.includes(idx) ? ' active' : '');
                btn.textContent = region;
                btn.onclick = () => toggleRegion(idx, btn);
                container.appendChild(btn);
            });
        }
        
        function toggleRegion(idx, btn) {
            const pos = selectedRegions.indexOf(idx);
            if (pos > -1) {
                selectedRegions.splice(pos, 1);
                btn.classList.remove('active');
            } else {
                selectedRegions.push(idx);
                btn.classList.add('active');
            }
            if (currentSolution) updateVisualizations();
        }
        
        // Update value displays for all range inputs
        document.querySelectorAll('input[type="range"]').forEach(input => {
            input.addEventListener('input', (e) => {
                const valSpan = document.getElementById('val-' + e.target.id);
                if (valSpan) valSpan.textContent = parseFloat(e.target.value).toFixed(2);
                
                // Update causal network if weights changed
                if (['wLC', 'wCL', 'wLS', 'wSL', 'wCS', 'wSC'].includes(e.target.id)) {
                    if (currentSolution) plotCausalNetwork();
                }
            });
        });
        
        // ‚úÖ –ù–û–í–û–ï: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
        document.getElementById('scenario').addEventListener('change', function(e) {
            const scenario = e.target.value;
            applyScenarioPreset(scenario);
        });
        
        function applyScenarioPreset(scenario) {
            const presets = {
                wake: {
                    ACh: 1.0, NE: 1.0, Orx: 1.0, Psilo: 0.0,
                    duration: 60,
                    description: 'Baseline wakefulness'
                },
                N2: {
                    ACh: 0.4, NE: 0.5, Orx: 0.4, Psilo: 0.0,
                    duration: 90,
                    description: 'Light sleep (N2 stage)'
                },
                N3: {
                    ACh: 0.3, NE: 0.4, Orx: 0.3, Psilo: 0.0,
                    duration: 120,
                    description: 'Deep sleep (N3 stage)'
                },
                propofol: {
                    ACh: 0.5, NE: 0.6, Orx: 0.5, Psilo: 0.0,
                    duration: 60,
                    description: 'Propofol anesthesia'
                },
                psychedelic: {
                    ACh: 1.2, NE: 1.2, Orx: 1.1, Psilo: 0.8,
                    duration: 360,
                    description: 'Psilocybin peak effects'
                },
                meditation: {
                    ACh: 0.9, NE: 0.8, Orx: 0.9, Psilo: 0.0,
                    duration: 60,
                    description: 'Meditative state'
                }
            };
            
            const preset = presets[scenario];
            if (preset) {
                // Update neuromodulators
                document.getElementById('ACh').value = preset.ACh;
                document.getElementById('NE').value = preset.NE;
                document.getElementById('Orx').value = preset.Orx;
                document.getElementById('Psilo').value = preset.Psilo;
                document.getElementById('duration').value = preset.duration;
                
                // Update displays
                document.getElementById('val-ACh').textContent = preset.ACh.toFixed(1);
                document.getElementById('val-NE').textContent = preset.NE.toFixed(1);
                document.getElementById('val-Orx').textContent = preset.Orx.toFixed(1);
                document.getElementById('val-Psilo').textContent = preset.Psilo.toFixed(1);
                document.getElementById('val-duration').textContent = preset.duration;
                
                document.getElementById('statusText').textContent = `‚úì Preset "${scenario}" applied: ${preset.description}`;
            }
        }
        
        // Get parameters from UI
        function getParams() {
            return {
                w_LC: parseFloat(document.getElementById('wLC').value),
                w_CL: parseFloat(document.getElementById('wCL').value),
                w_LS: parseFloat(document.getElementById('wLS').value),
                w_SL: parseFloat(document.getElementById('wSL').value),
                w_CS: parseFloat(document.getElementById('wCS').value),
                w_SC: parseFloat(document.getElementById('wSC').value),
                k_ign: parseFloat(document.getElementById('kign').value),
                L_thresh: parseFloat(document.getElementById('Lthresh').value),
                alpha_att: parseFloat(document.getElementById('alphaAtt').value),
                k_bind: parseFloat(document.getElementById('kbind').value),
                C_opt: parseFloat(document.getElementById('Copt').value),
                L_crit: parseFloat(document.getElementById('Lcrit').value),
                beta_intero: parseFloat(document.getElementById('betaIntero').value),
                alpha_agency: parseFloat(document.getElementById('alphaAgency').value),
                alpha_psych: parseFloat(document.getElementById('alphaPsych').value),
                D_L: parseFloat(document.getElementById('DL').value),
                D_C: parseFloat(document.getElementById('DC').value),
                D_S: parseFloat(document.getElementById('DS').value),
                delta_C: parseFloat(document.getElementById('deltaC').value),
                ACh: parseFloat(document.getElementById('ACh').value),
                NE: parseFloat(document.getElementById('NE').value),
                Orx: parseFloat(document.getElementById('Orx').value),
                Psilo: parseFloat(document.getElementById('Psilo').value)
            };
        }
        
        // Simplified structural connectivity (13x13 symmetric matrix)
        function createSC() {
            const n = 13;
            const SC = Array(n).fill(0).map(() => Array(n).fill(0));
            
            // Visual stream
            SC[0][1] = SC[1][0] = 0.80; SC[0][2] = SC[2][0] = 0.60;
            SC[1][3] = SC[3][1] = 0.75; SC[2][3] = SC[3][2] = 0.50;
            
            // Frontal
            SC[4][5] = SC[5][4] = 0.65; SC[4][6] = SC[6][4] = 0.70;
            SC[5][6] = SC[6][5] = 0.55;
            
            // Parietal-Frontal
            SC[4][7] = SC[7][4] = 0.60; SC[5][7] = SC[7][5] = 0.50;
            
            // DMN
            SC[4][9] = SC[9][4] = 0.55; SC[5][9] = SC[9][5] = 0.65;
            SC[8][9] = SC[9][8] = 0.50;
            
            // Claustrum broad
            for (let i = 0; i < 10; i++) {
                SC[10][i] = SC[i][10] = 0.35;
            }
            
            // Pulvinar attention
            SC[11][7] = SC[7][11] = 0.65; SC[11][1] = SC[1][11] = 0.50;
            
            // SC visual
            SC[12][0] = SC[0][12] = 0.55; SC[12][7] = SC[7][12] = 0.50;
            
            return SC;
        }
        
        // Graph Laplacian
        function graphLaplacian(X, SC, D) {
            const n = X.length;
            const result = Array(n).fill(0);
            
            for (let i = 0; i < n; i++) {
                let sum = 0;
                let degree = 0;
                for (let j = 0; j < n; j++) {
                    sum += SC[i][j] * X[j];
                    degree += SC[i][j];
                }
                result[i] = D * (sum - degree * X[i]);
            }
            
            return result;
        }
        
        // Sigmoid function
        function sigmoid(x) {
            return x >= 0 ? 1 / (1 + Math.exp(-x)) : Math.exp(x) / (1 + Math.exp(x));
        }
        
        // Heaviside function
        function heaviside(x) {
            return x > 0 ? 1 : 0;
        }
        
        // RK4 integration step
        function rk4Step(state, dt, params, SC) {
            const k1 = computeDerivatives(state, params, SC);
            const k2 = computeDerivatives(addStates(state, scaleState(k1, dt/2)), params, SC);
            const k3 = computeDerivatives(addStates(state, scaleState(k2, dt/2)), params, SC);
            const k4 = computeDerivatives(addStates(state, scaleState(k3, dt)), params, SC);
            
            const dState = scaleState(addStates(k1, scaleState(addStates(k2, k3), 2), k4), dt/6);
            return addStates(state, dState);
        }
        
        function scaleState(state, scalar) {
            return {
                L: state.L.map(x => x * scalar),
                C: state.C.map(x => x * scalar),
                S: state.S.map(x => x * scalar),
                A: state.A.map(x => x * scalar)
            };
        }
        
        function addStates(...states) {
            const n = states[0].L.length;
            const result = {
                L: Array(n).fill(0),
                C: Array(n).fill(0),
                S: Array(n).fill(0),
                A: Array(n).fill(0)
            };
            
            states.forEach(state => {
                for (let i = 0; i < n; i++) {
                    result.L[i] += state.L[i];
                    result.C[i] += state.C[i];
                    result.S[i] += state.S[i];
                    result.A[i] += state.A[i];
                }
            });
            
            return result;
        }
        
        // Compute derivatives (DCD 4.0 dynamics)
        function computeDerivatives(state, params, SC) {
            const n = state.L.length;
            const dL = Array(n).fill(0);
            const dC = Array(n).fill(0);
            const dS = Array(n).fill(0);
            const dA = Array(n).fill(0);
            
            // Neuromodulatory target
            const L_target = 10 * sigmoid(2.5 * params.ACh + 2.0 * params.NE + 3.0 * params.Orx - 5.0);
            
            for (let i = 0; i < n; i++) {
                // dL/dt
                dL[i] = 0.5 * state.L[i] * (1 - state.L[i]/10) + // homeostasis
                        0.5 * (L_target - state.L[i]) + // neuromod drive
                        params.w_CL * state.C[i] + // C‚ÜíL
                        params.w_SL * state.S[i]; // S‚ÜíL
                
                // Ignition threshold (attention-modulated)
                const L_thresh_eff = params.L_thresh * (1 - params.alpha_att * state.A[i]);
                const h_ign = sigmoid(params.k_ign * (state.L[i] - L_thresh_eff));
                
                // dC/dt
                const g_att = Math.exp(-Math.pow(state.C[i] - params.C_opt, 2) / 12.5);
                dC[i] = params.w_LC * state.L[i] * h_ign * (10 - state.C[i])/10 + // arousal-gated
                        0.8 * 0.4 * state.A[i] + // sensory input (simplified)
                        params.w_SC * state.S[i] * g_att + // metacog modulation
                        params.k_bind * state.L[i] * state.C[i] * (10 - state.C[i]) * g_att - // binding
                        params.delta_C * state.C[i]; // decay
                
                // dS/dt
                const H_L = heaviside(state.L[i] - params.L_crit);
                dS[i] = params.w_LS * state.L[i] * H_L + // L‚ÜíS (PFC threshold)
                        params.w_CS * Math.log(1 + state.C[i]) + // C‚ÜíS
                        (i === 8 ? params.beta_intero * state.L[i] * (1 - state.S[i]/10) : 0) - // aINS interoception
                        params.alpha_agency * Math.abs(dC[i]) * state.S[i]; // agency disruption
                
                // DMN-specific psychedelic suppression
                if (DMN_INDICES.includes(i)) {
                    dS[i] -= params.alpha_psych * params.Psilo * state.S[i];
                }
                
                // dA/dt
                const salience = state.C[i] / 10;
                dA[i] = 0.5 * salience * (1 - state.A[i]) - // bottom-up
                        0.4 * state.A[i]; // decay
            }
            
            // Add spatial coupling
            const dL_spatial = graphLaplacian(state.L, SC, params.D_L);
            const dC_spatial = graphLaplacian(state.C, SC, params.D_C);
            const dS_spatial = graphLaplacian(state.S, SC, params.D_S);
            
            for (let i = 0; i < n; i++) {
                dL[i] += dL_spatial[i];
                dC[i] += dC_spatial[i];
                dS[i] += dS_spatial[i];
            }
            
            return { L: dL, C: dC, S: dS, A: dA };
        }
        
        // ‚úÖ –£–õ–£–ß–®–ï–ù–ù–û–ï: Run simulation with error handling and progress
        function runSimulation() {
            try {
                document.getElementById('statusText').textContent = 'Running...';
                
                const params = getParams();
                const SC = createSC();
                const duration = parseFloat(document.getElementById('duration').value);
                const dt = parseFloat(document.getElementById('dt').value) / 1000; // ms to min
                const steps = Math.floor(duration / dt);
                
                // Validation
                if (steps > 100000) {
                    alert('‚ö†Ô∏è Too many steps! Please increase time step or decrease duration.');
                    document.getElementById('statusText').textContent = 'Error: Too many steps';
                    return;
                }
                
                if (steps < 10) {
                    alert('‚ö†Ô∏è Too few steps! Please decrease time step or increase duration.');
                    document.getElementById('statusText').textContent = 'Error: Too few steps';
                    return;
                }
                
                // Initialize state based on scenario
                const scenario = document.getElementById('scenario').value;
                let state = initializeState(scenario);
                
                // Storage
                const solution = {
                    t: [0],
                    L: [state.L.slice()],
                    C: [state.C.slice()],
                    S: [state.S.slice()],
                    A: [state.A.slice()]
                };
                
                // Integration loop with progress updates
                const progressInterval = Math.max(1, Math.floor(steps / 20));
                for (let step = 0; step < steps; step++) {
                    state = rk4Step(state, dt, params, SC);
                    
                    // Clip to physical bounds
                    state.L = state.L.map(x => Math.max(0, Math.min(10, x)));
                    state.C = state.C.map(x => Math.max(0, Math.min(10, x)));
                    state.S = state.S.map(x => Math.max(0, Math.min(10, x)));
                    state.A = state.A.map(x => Math.max(0, Math.min(1, x)));
                    
                    if (step % 10 === 0) { // Store every 10 steps
                        solution.t.push((step + 1) * dt);
                        solution.L.push(state.L.slice());
                        solution.C.push(state.C.slice());
                        solution.S.push(state.S.slice());
                        solution.A.push(state.A.slice());
                    }
                    
                    // Progress update
                    if (step % progressInterval === 0 && step > 0) {
                        const progress = Math.round((step / steps) * 100);
                        document.getElementById('statusText').textContent = `Running... ${progress}%`;
                    }
                }
                
                currentSolution = solution;
                updateVisualizations();
                updateStatus(state);
                
                document.getElementById('statusText').textContent = `‚úì Complete (${steps} steps, ${solution.t.length} points)`;
            } catch (error) {
                console.error('Simulation error:', error);
                document.getElementById('statusText').textContent = '‚úó Error: ' + error.message;
                alert('Simulation error: ' + error.message + '\n\nCheck console for details.');
            }
        }
        
        function initializeState(scenario) {
            const n = 13;
            const states = {
                wake: { L: 8.0, C: 7.5, S: 7.5, A: 0.3 },
                N2: { L: 4.5, C: 3.5, S: 2.0, A: 0.1 },
                N3: { L: 3.0, C: 2.0, S: 1.0, A: 0.05 },
                propofol: { L: 3.5, C: 2.5, S: 1.5, A: 0.1 },
                psychedelic: { L: 9.0, C: 9.0, S: 6.0, A: 0.5 },
                meditation: { L: 7.0, C: 5.0, S: 8.5, A: 0.7 },
                custom: { L: 6.0, C: 6.0, S: 6.0, A: 0.3 }
            };
            
            const init = states[scenario] || states.custom;
            return {
                L: Array(n).fill(init.L).map((x, i) => x + (Math.random() - 0.5) * 0.5),
                C: Array(n).fill(init.C).map((x, i) => x + (Math.random() - 0.5) * 0.5),
                S: Array(n).fill(init.S).map((x, i) => x + (Math.random() - 0.5) * 0.5),
                A: Array(n).fill(init.A).map((x, i) => x + (Math.random() - 0.5) * 0.1)
            };
        }
        
        function updateVisualizations() {
            if (!currentSolution) return;
            
            plot3DTrajectory();
            plotTimeSeries();
            plotHeatmap();
            plotDMNComparison();
            plotPhasePortrait();
            plotCausalNetwork();
        }
        
        function plot3DTrajectory() {
            const sol = currentSolution;
            const L_mean = sol.L.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            const C_mean = sol.C.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            const S_mean = sol.S.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            
            const trace = {
                type: 'scatter3d',
                mode: 'lines+markers',
                x: L_mean,
                y: C_mean,
                z: S_mean,
                line: { color: sol.t, colorscale: 'Viridis', width: 4 },
                marker: { size: 3, color: sol.t, colorscale: 'Viridis' }
            };
            
            const layout = {
                scene: {
                    xaxis: { title: 'Level (L)', range: [0, 10] },
                    yaxis: { title: 'Content (C)', range: [0, 10] },
                    zaxis: { title: 'Self (S)', range: [0, 10] }
                },
                margin: { l: 0, r: 0, t: 0, b: 0 }
            };
            
            Plotly.newPlot('plot3D', [trace], layout, { responsive: true });
        }
        
        function plotTimeSeries() {
            const sol = currentSolution;
            const L_mean = sol.L.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            const C_mean = sol.C.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            const S_mean = sol.S.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            
            const traces = [
                { x: sol.t, y: L_mean, name: 'L', line: { color: '#e74c3c', width: 2 } },
                { x: sol.t, y: C_mean, name: 'C', line: { color: '#3498db', width: 2 } },
                { x: sol.t, y: S_mean, name: 'S', line: { color: '#2ecc71', width: 2 } },
                { x: sol.t, y: Array(sol.t.length).fill(3.4), name: 'L_thresh', 
                  line: { dash: 'dash', color: 'gray', width: 1 } }
            ];
            
            const layout = {
                xaxis: { title: 'Time (min)' },
                yaxis: { title: 'Value', range: [0, 10] },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                legend: { x: 1, xanchor: 'right', y: 1 }
            };
            
            Plotly.newPlot('plotTimeSeries', traces, layout, { responsive: true });
        }
        
        function plotHeatmap() {
            const sol = currentSolution;
            const L_matrix = sol.L[0].map((_, i) => sol.L.map(arr => arr[i]));
            
            const trace = {
                type: 'heatmap',
                z: L_matrix,
                x: sol.t,
                y: REGIONS,
                colorscale: 'RdYlBu',
                reversescale: true,
                zmin: 0,
                zmax: 10
            };
            
            const layout = {
                xaxis: { title: 'Time (min)' },
                yaxis: { title: 'Region' },
                margin: { l: 100, r: 50, t: 20, b: 40 }
            };
            
            Plotly.newPlot('plotHeatmap', [trace], layout, { responsive: true });
        }
        
        function plotDMNComparison() {
            const sol = currentSolution;
            const S_DMN = sol.S.map(arr => {
                const dmn = DMN_INDICES.map(i => arr[i]);
                return dmn.reduce((a, b) => a + b) / dmn.length;
            });
            
            const nonDMN = [...Array(13).keys()].filter(i => !DMN_INDICES.includes(i));
            const S_nonDMN = sol.S.map(arr => {
                const non = nonDMN.map(i => arr[i]);
                return non.reduce((a, b) => a + b) / non.length;
            });
            
            const traces = [
                { x: sol.t, y: S_DMN, name: 'S_DMN', line: { color: '#9b59b6', width: 3 } },
                { x: sol.t, y: S_nonDMN, name: 'S_non-DMN', line: { color: '#f39c12', width: 3 } }
            ];
            
            const layout = {
                xaxis: { title: 'Time (min)' },
                yaxis: { title: 'Self/Metacognition', range: [0, 10] },
                margin: { l: 50, r: 20, t: 20, b: 40 }
            };
            
            Plotly.newPlot('plotDMN', traces, layout, { responsive: true });
        }
        
        function plotPhasePortrait() {
            const sol = currentSolution;
            const L_mean = sol.L.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            const C_mean = sol.C.map(arr => arr.reduce((a, b) => a + b) / arr.length);
            
            const trace = {
                type: 'scatter',
                mode: 'lines+markers',
                x: L_mean,
                y: C_mean,
                marker: { size: 4, color: sol.t, colorscale: 'Viridis' },
                line: { width: 1, color: 'rgba(0,0,0,0.3)' }
            };
            
            const layout = {
                xaxis: { title: 'Level (L)', range: [0, 10] },
                yaxis: { title: 'Content (C)', range: [0, 10] },
                margin: { l: 50, r: 20, t: 20, b: 40 }
            };
            
            Plotly.newPlot('plotPhase', [trace], layout, { responsive: true });
        }
        
        function plotCausalNetwork() {
            const params = getParams();
            const weights = [
                { source: 'L', target: 'C', value: params.w_LC },
                { source: 'C', target: 'L', value: params.w_CL },
                { source: 'L', target: 'S', value: params.w_LS },
                { source: 'S', target: 'L', value: params.w_SL },
                { source: 'C', target: 'S', value: params.w_CS },
                { source: 'S', target: 'C', value: params.w_SC }
            ];
            
            const nodes = ['L', 'C', 'S'];
            const positions = { L: [0, 1], C: [0.866, -0.5], S: [-0.866, -0.5] };
            
            // Create edges
            const edge_traces = weights.map(w => ({
                type: 'scatter',
                mode: 'lines',
                x: [positions[w.source][0], positions[w.target][0]],
                y: [positions[w.source][1], positions[w.target][1]],
                line: { width: w.value * 10, color: 'rgba(102, 126, 234, 0.6)' },
                hoverinfo: 'text',
                text: `${w.source}‚Üí${w.target}: ${w.value.toFixed(2)}`,
                showlegend: false
            }));
            
            // Create nodes
            const node_trace = {
                type: 'scatter',
                mode: 'markers+text',
                x: nodes.map(n => positions[n][0]),
                y: nodes.map(n => positions[n][1]),
                text: nodes,
                textposition: 'middle center',
                marker: { size: 50, color: '#667eea', line: { width: 2, color: 'white' } },
                textfont: { size: 18, color: 'white', family: 'Arial Black' },
                hoverinfo: 'text'
            };
            
            const layout = {
                xaxis: { visible: false, range: [-1.5, 1.5] },
                yaxis: { visible: false, range: [-1.5, 1.5] },
                margin: { l: 20, r: 20, t: 20, b: 20 },
                hovermode: 'closest'
            };
            
            Plotly.newPlot('plotNetwork', [...edge_traces, node_trace], layout, { responsive: true });
        }
        
        function updateStatus(state) {
            const L_mean = state.L.reduce((a, b) => a + b) / state.L.length;
            const C_mean = state.C.reduce((a, b) => a + b) / state.C.length;
            const S_mean = state.S.reduce((a, b) => a + b) / state.S.length;
            
            // PCI estimate
            const PCI = L_mean / 10;
            document.getElementById('pciValue').textContent = PCI.toFixed(3);
            
            // Clinical state classification
            let clinicalState;
            if (L_mean < 2.5) clinicalState = 'VS/UWS';
            else if (L_mean < 4.0) clinicalState = 'MCS-';
            else if (L_mean < 5.5) clinicalState = 'MCS+';
            else if (L_mean < 7.0) clinicalState = 'EMCS';
            else clinicalState = 'Conscious';
            
            document.getElementById('clinicalState').textContent = clinicalState;
            
            // Mock R¬≤ (would require empirical data)
            document.getElementById('r2Value').textContent = '0.73 (simulated)';
        }
        
        function resetParams() {
            document.getElementById('wLC').value = 0.58;
            document.getElementById('wCL').value = 0.28;
            document.getElementById('wLS').value = 0.72;
            document.getElementById('wSL').value = 0.18;
            document.getElementById('wCS').value = 0.53;
            document.getElementById('wSC').value = 0.42;
            document.getElementById('kign').value = 2.3;
            document.getElementById('Lthresh').value = 3.4;
            document.getElementById('alphaAtt').value = 0.5;
            document.getElementById('kbind').value = 0.05;
            document.getElementById('Copt').value = 7.5;
            document.getElementById('Lcrit').value = 4.0;
            document.getElementById('betaIntero').value = 0.5;
            document.getElementById('alphaAgency').value = 0.10;
            document.getElementById('alphaPsych').value = 4.8;
            document.getElementById('DL').value = 0.05;
            document.getElementById('DC').value = 0.15;
            document.getElementById('DS').value = 0.02;
            document.getElementById('deltaC').value = 0.5;
            document.getElementById('ACh').value = 1.0;
            document.getElementById('NE').value = 1.0;
            document.getElementById('Orx').value = 1.0;
            document.getElementById('Psilo').value = 0.0;
            document.getElementById('scenario').value = 'wake';
            document.getElementById('duration').value = 60;
            document.getElementById('dt').value = 10;
            
            document.querySelectorAll('input[type="range"], input[type="number"]').forEach(input => {
                const valSpan = document.getElementById('val-' + input.id);
                if (valSpan) {
                    const val = parseFloat(input.value);
                    valSpan.textContent = (input.step && parseFloat(input.step) >= 1) ? val.toFixed(0) : val.toFixed(2);
                }
            });
            
            document.getElementById('statusText').textContent = '‚úì Parameters reset to defaults';
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initRegionSelector();
            runSimulation();
        });
    </script>
</body>
</html>
